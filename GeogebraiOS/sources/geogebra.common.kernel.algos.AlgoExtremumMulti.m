//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/jacky/GSoC/geogebra_iOS/geogebra/geogebra/common/src/geogebra/common/kernel/algos/AlgoExtremumMulti.java
//


#include "IOSObjectArray.h"
#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "geogebra/common/kernel/Construction.h"
#include "geogebra/common/kernel/Kernel.h"
#include "geogebra/common/kernel/algos/AlgoElement.h"
#include "geogebra/common/kernel/algos/AlgoExtremumMulti.h"
#include "geogebra/common/kernel/algos/AlgoGeoPointsFunction.h"
#include "geogebra/common/kernel/arithmetic/NumberValue.h"
#include "geogebra/common/kernel/commands/Commands.h"
#include "geogebra/common/kernel/geos/GeoElement.h"
#include "geogebra/common/kernel/geos/GeoFunction.h"
#include "geogebra/common/kernel/geos/GeoPoint.h"
#include "geogebra/common/kernel/optimization/ExtremumFinder.h"
#include "geogebra/common/kernel/roots/RealRootFunction.h"
#include "geogebra/common/main/App.h"
#include "java/lang/Double.h"
#include "java/lang/Exception.h"
#include "java/lang/Math.h"
#include "java/util/ArrayList.h"

#define GeogebraCommonKernelAlgosAlgoExtremumMulti_PIXELS_BETWEEN_SAMPLES 5
#define GeogebraCommonKernelAlgosAlgoExtremumMulti_MAX_SAMPLES 400
#define GeogebraCommonKernelAlgosAlgoExtremumMulti_MIN_SAMPLES 50

@interface GeogebraCommonKernelAlgosAlgoExtremumMulti () {
 @public
  GeogebraCommonKernelGeosGeoFunction *f1_;
  id<GeogebraCommonKernelArithmeticNumberValue> left_;
  GeogebraCommonKernelGeosGeoElement *geoleft_;
  id<GeogebraCommonKernelArithmeticNumberValue> right_;
  GeogebraCommonKernelGeosGeoElement *georight_;
}

+ (jdouble)gradientWithGeogebraCommonKernelRootsRealRootFunction:(id<GeogebraCommonKernelRootsRealRootFunction>)rrf
                                                      withDouble:(jdouble)x
                                                      withDouble:(jdouble)l
                                                      withDouble:(jdouble)r;

@end

J2OBJC_FIELD_SETTER(GeogebraCommonKernelAlgosAlgoExtremumMulti, f1_, GeogebraCommonKernelGeosGeoFunction *)
J2OBJC_FIELD_SETTER(GeogebraCommonKernelAlgosAlgoExtremumMulti, left_, id<GeogebraCommonKernelArithmeticNumberValue>)
J2OBJC_FIELD_SETTER(GeogebraCommonKernelAlgosAlgoExtremumMulti, geoleft_, GeogebraCommonKernelGeosGeoElement *)
J2OBJC_FIELD_SETTER(GeogebraCommonKernelAlgosAlgoExtremumMulti, right_, id<GeogebraCommonKernelArithmeticNumberValue>)
J2OBJC_FIELD_SETTER(GeogebraCommonKernelAlgosAlgoExtremumMulti, georight_, GeogebraCommonKernelGeosGeoElement *)

J2OBJC_STATIC_FIELD_GETTER(GeogebraCommonKernelAlgosAlgoExtremumMulti, PIXELS_BETWEEN_SAMPLES, jint)

J2OBJC_STATIC_FIELD_GETTER(GeogebraCommonKernelAlgosAlgoExtremumMulti, MAX_SAMPLES, jint)

J2OBJC_STATIC_FIELD_GETTER(GeogebraCommonKernelAlgosAlgoExtremumMulti, MIN_SAMPLES, jint)

__attribute__((unused)) static void GeogebraCommonKernelAlgosAlgoExtremumMulti_compute(GeogebraCommonKernelAlgosAlgoExtremumMulti *self);

__attribute__((unused)) static jint GeogebraCommonKernelAlgosAlgoExtremumMulti_findNumberOfSamplesWithDouble_withDouble_(GeogebraCommonKernelAlgosAlgoExtremumMulti *self, jdouble l, jdouble r);

__attribute__((unused)) static jdouble GeogebraCommonKernelAlgosAlgoExtremumMulti_gradientWithGeogebraCommonKernelRootsRealRootFunction_withDouble_withDouble_withDouble_(id<GeogebraCommonKernelRootsRealRootFunction> rrf, jdouble x, jdouble l, jdouble r);

@implementation GeogebraCommonKernelAlgosAlgoExtremumMulti

- (instancetype)initWithGeogebraCommonKernelConstruction:(GeogebraCommonKernelConstruction *)cons
                                       withNSStringArray:(IOSObjectArray *)labels
                 withGeogebraCommonKernelGeosGeoFunction:(GeogebraCommonKernelGeosGeoFunction *)function
           withGeogebraCommonKernelArithmeticNumberValue:(id<GeogebraCommonKernelArithmeticNumberValue>)left
           withGeogebraCommonKernelArithmeticNumberValue:(id<GeogebraCommonKernelArithmeticNumberValue>)right {
  GeogebraCommonKernelAlgosAlgoExtremumMulti_initWithGeogebraCommonKernelConstruction_withNSStringArray_withGeogebraCommonKernelGeosGeoFunction_withGeogebraCommonKernelArithmeticNumberValue_withGeogebraCommonKernelArithmeticNumberValue_(self, cons, labels, function, left, right);
  return self;
}

- (GeogebraCommonKernelCommandsCommandsEnum *)getClassName {
  return GeogebraCommonKernelCommandsCommandsEnum_get_Extremum();
}

- (IOSObjectArray *)getExtremumPoints {
  return [self getPoints];
}

- (void)setInputOutput {
  GeogebraCommonKernelAlgosAlgoElement_setAndConsume_input_(self, [IOSObjectArray newArrayWithLength:3 type:GeogebraCommonKernelGeosGeoElement_class_()]);
  IOSObjectArray_Set(input_, 0, [((GeogebraCommonKernelGeosGeoFunction *) nil_chk(f1_)) toGeoElement]);
  IOSObjectArray_Set(input_, 1, geoleft_);
  IOSObjectArray_Set(input_, 2, georight_);
  [super setOutputWithGeogebraCommonKernelGeosGeoElementArray:[self getPoints]];
  [self noUndefinedPointsInAlgebraViewWithGeogebraCommonKernelGeosGeoPointArray:[self getPoints]];
  [self setDependencies];
}

- (void)compute {
  GeogebraCommonKernelAlgosAlgoExtremumMulti_compute(self);
}

+ (IOSDoubleArray *)findExtremumsWithGeogebraCommonKernelRootsRealRootFunction:(id<GeogebraCommonKernelRootsRealRootFunction>)rrfunc
                                                                    withDouble:(jdouble)l
                                                                    withDouble:(jdouble)r
                                                                       withInt:(jint)samples {
  return GeogebraCommonKernelAlgosAlgoExtremumMulti_findExtremumsWithGeogebraCommonKernelRootsRealRootFunction_withDouble_withDouble_withInt_(rrfunc, l, r, samples);
}

- (jint)findNumberOfSamplesWithDouble:(jdouble)l
                           withDouble:(jdouble)r {
  return GeogebraCommonKernelAlgosAlgoExtremumMulti_findNumberOfSamplesWithDouble_withDouble_(self, l, r);
}

+ (jdouble)gradientWithGeogebraCommonKernelRootsRealRootFunction:(id<GeogebraCommonKernelRootsRealRootFunction>)rrf
                                                      withDouble:(jdouble)x
                                                      withDouble:(jdouble)l
                                                      withDouble:(jdouble)r {
  return GeogebraCommonKernelAlgosAlgoExtremumMulti_gradientWithGeogebraCommonKernelRootsRealRootFunction_withDouble_withDouble_withDouble_(rrf, x, l, r);
}

- (instancetype)initWithGeogebraCommonKernelConstruction:(GeogebraCommonKernelConstruction *)cons {
  GeogebraCommonKernelAlgosAlgoExtremumMulti_initWithGeogebraCommonKernelConstruction_(self, cons);
  return self;
}

- (void)dealloc {
  RELEASE_(f1_);
  RELEASE_(left_);
  RELEASE_(geoleft_);
  RELEASE_(right_);
  RELEASE_(georight_);
  [super dealloc];
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithGeogebraCommonKernelConstruction:withNSStringArray:withGeogebraCommonKernelGeosGeoFunction:withGeogebraCommonKernelArithmeticNumberValue:withGeogebraCommonKernelArithmeticNumberValue:", "AlgoExtremumMulti", NULL, 0x1, NULL, NULL },
    { "getClassName", NULL, "Lgeogebra.common.kernel.commands.Commands;", 0x1, NULL, NULL },
    { "getExtremumPoints", NULL, "[Lgeogebra.common.kernel.geos.GeoPoint;", 0x1, NULL, NULL },
    { "setInputOutput", NULL, "V", 0x4, NULL, NULL },
    { "compute", NULL, "V", 0x11, NULL, NULL },
    { "findExtremumsWithGeogebraCommonKernelRootsRealRootFunction:withDouble:withDouble:withInt:", "findExtremums", "[D", 0x19, NULL, NULL },
    { "findNumberOfSamplesWithDouble:withDouble:", "findNumberOfSamples", "I", 0x11, NULL, NULL },
    { "gradientWithGeogebraCommonKernelRootsRealRootFunction:withDouble:withDouble:withDouble:", "gradient", "D", 0x1a, NULL, NULL },
    { "initWithGeogebraCommonKernelConstruction:", "AlgoExtremumMulti", NULL, 0x1, NULL, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "PIXELS_BETWEEN_SAMPLES_", NULL, 0x1a, "I", NULL, NULL, .constantValue.asInt = GeogebraCommonKernelAlgosAlgoExtremumMulti_PIXELS_BETWEEN_SAMPLES },
    { "MAX_SAMPLES_", NULL, 0x1a, "I", NULL, NULL, .constantValue.asInt = GeogebraCommonKernelAlgosAlgoExtremumMulti_MAX_SAMPLES },
    { "MIN_SAMPLES_", NULL, 0x1a, "I", NULL, NULL, .constantValue.asInt = GeogebraCommonKernelAlgosAlgoExtremumMulti_MIN_SAMPLES },
    { "f1_", NULL, 0x2, "Lgeogebra.common.kernel.geos.GeoFunction;", NULL, NULL,  },
    { "left_", NULL, 0x2, "Lgeogebra.common.kernel.arithmetic.NumberValue;", NULL, NULL,  },
    { "geoleft_", NULL, 0x2, "Lgeogebra.common.kernel.geos.GeoElement;", NULL, NULL,  },
    { "right_", NULL, 0x2, "Lgeogebra.common.kernel.arithmetic.NumberValue;", NULL, NULL,  },
    { "georight_", NULL, 0x2, "Lgeogebra.common.kernel.geos.GeoElement;", NULL, NULL,  },
  };
  static const J2ObjcClassInfo _GeogebraCommonKernelAlgosAlgoExtremumMulti = { 2, "AlgoExtremumMulti", "geogebra.common.kernel.algos", NULL, 0x1, 9, methods, 8, fields, 0, NULL, 0, NULL, NULL, NULL };
  return &_GeogebraCommonKernelAlgosAlgoExtremumMulti;
}

@end

void GeogebraCommonKernelAlgosAlgoExtremumMulti_initWithGeogebraCommonKernelConstruction_withNSStringArray_withGeogebraCommonKernelGeosGeoFunction_withGeogebraCommonKernelArithmeticNumberValue_withGeogebraCommonKernelArithmeticNumberValue_(GeogebraCommonKernelAlgosAlgoExtremumMulti *self, GeogebraCommonKernelConstruction *cons, IOSObjectArray *labels, GeogebraCommonKernelGeosGeoFunction *function, id<GeogebraCommonKernelArithmeticNumberValue> left, id<GeogebraCommonKernelArithmeticNumberValue> right) {
  GeogebraCommonKernelAlgosAlgoGeoPointsFunction_initWithGeogebraCommonKernelConstruction_withNSStringArray_withBoolean_withGeogebraCommonKernelGeosGeoFunction_(self, cons, labels, ![((GeogebraCommonKernelConstruction *) nil_chk(cons)) isSuppressLabelsActive], function);
  GeogebraCommonKernelAlgosAlgoExtremumMulti_set_f1_(self, function);
  GeogebraCommonKernelAlgosAlgoExtremumMulti_set_left_(self, left);
  GeogebraCommonKernelAlgosAlgoExtremumMulti_set_geoleft_(self, [((id<GeogebraCommonKernelArithmeticNumberValue>) nil_chk(left)) toGeoElement]);
  GeogebraCommonKernelAlgosAlgoExtremumMulti_set_right_(self, right);
  GeogebraCommonKernelAlgosAlgoExtremumMulti_set_georight_(self, [((id<GeogebraCommonKernelArithmeticNumberValue>) nil_chk(right)) toGeoElement]);
  jint number = (labels == nil ? 1 : JavaLangMath_maxWithInt_withInt_(1, labels->size_));
  [self setInputOutput];
  GeogebraCommonKernelAlgosAlgoExtremumMulti_compute(self);
  IOSObjectArray *gpt = [self getPoints];
  if (![((GeogebraCommonKernelGeosGeoPoint *) nil_chk(IOSObjectArray_Get(nil_chk(gpt), 0))) isDefined]) {
    [((GeogebraCommonKernelGeosGeoPoint *) nil_chk(IOSObjectArray_Get(gpt, 0))) setCoordsWithDouble:0 withDouble:0 withDouble:1];
    [((GeogebraCommonKernelGeosGeoPoint *) nil_chk(IOSObjectArray_Get(gpt, 0))) update];
    [((GeogebraCommonKernelGeosGeoPoint *) nil_chk(IOSObjectArray_Get(gpt, 0))) setUndefined];
    [((GeogebraCommonKernelGeosGeoPoint *) nil_chk(IOSObjectArray_Get(gpt, 0))) update];
  }
}

GeogebraCommonKernelAlgosAlgoExtremumMulti *new_GeogebraCommonKernelAlgosAlgoExtremumMulti_initWithGeogebraCommonKernelConstruction_withNSStringArray_withGeogebraCommonKernelGeosGeoFunction_withGeogebraCommonKernelArithmeticNumberValue_withGeogebraCommonKernelArithmeticNumberValue_(GeogebraCommonKernelConstruction *cons, IOSObjectArray *labels, GeogebraCommonKernelGeosGeoFunction *function, id<GeogebraCommonKernelArithmeticNumberValue> left, id<GeogebraCommonKernelArithmeticNumberValue> right) {
  GeogebraCommonKernelAlgosAlgoExtremumMulti *self = [GeogebraCommonKernelAlgosAlgoExtremumMulti alloc];
  GeogebraCommonKernelAlgosAlgoExtremumMulti_initWithGeogebraCommonKernelConstruction_withNSStringArray_withGeogebraCommonKernelGeosGeoFunction_withGeogebraCommonKernelArithmeticNumberValue_withGeogebraCommonKernelArithmeticNumberValue_(self, cons, labels, function, left, right);
  return self;
}

void GeogebraCommonKernelAlgosAlgoExtremumMulti_compute(GeogebraCommonKernelAlgosAlgoExtremumMulti *self) {
  IOSDoubleArray *extremums = [IOSDoubleArray arrayWithLength:0];
  jint numberOfExtremums = 0;
  jdouble l = [((id<GeogebraCommonKernelArithmeticNumberValue>) nil_chk(self->left_)) getDouble];
  jdouble r = [((id<GeogebraCommonKernelArithmeticNumberValue>) nil_chk(self->right_)) getDouble];
  if (![((GeogebraCommonKernelGeosGeoElement *) nil_chk([((GeogebraCommonKernelGeosGeoFunction *) nil_chk(self->f1_)) toGeoElement])) isDefined] || ![((GeogebraCommonKernelGeosGeoElement *) nil_chk(self->geoleft_)) isDefined] || ![((GeogebraCommonKernelGeosGeoElement *) nil_chk(self->georight_)) isDefined]) {
    [self setPointsWithDoubleArray:[IOSDoubleArray arrayWithLength:1] withInt:0];
  }
  else {
    if (l > r) {
      jdouble tmp = l;
      l = r;
      r = tmp;
    }
    id<GeogebraCommonKernelRootsRealRootFunction> rrfunc = [self->f1_ getRealRootFunctionY];
    jint n = GeogebraCommonKernelAlgosAlgoExtremumMulti_findNumberOfSamplesWithDouble_withDouble_(self, l, r);
    jint m = n;
    @try {
      do {
        extremums = GeogebraCommonKernelAlgosAlgoExtremumMulti_findExtremumsWithGeogebraCommonKernelRootsRealRootFunction_withDouble_withDouble_withInt_(rrfunc, l, r, m);
        if (extremums == nil) {
          numberOfExtremums = 0;
        }
        else {
          numberOfExtremums = extremums->size_;
        }
        if (numberOfExtremums < m / 2) {
          break;
        }
        m = m * 2;
      }
      while (m < GeogebraCommonKernelAlgosAlgoExtremumMulti_MAX_SAMPLES);
      if (m > GeogebraCommonKernelAlgosAlgoExtremumMulti_MAX_SAMPLES) GeogebraCommonMainApp_debugWithNSString_(@"We have probably lost some extremums...");
    }
    @catch (JavaLangException *e) {
      GeogebraCommonMainApp_debugWithNSString_(JreStrcat("$$", @"Exception in compute() ", [((JavaLangException *) nil_chk(e)) description]));
    }
    if (numberOfExtremums == 0) {
      [self setPointsWithDoubleArray:[IOSDoubleArray arrayWithLength:1] withInt:0];
    }
    else {
      [self setPointsWithDoubleArray:extremums withInt:numberOfExtremums];
    }
  }
}

IOSDoubleArray *GeogebraCommonKernelAlgosAlgoExtremumMulti_findExtremumsWithGeogebraCommonKernelRootsRealRootFunction_withDouble_withDouble_withInt_(id<GeogebraCommonKernelRootsRealRootFunction> rrfunc, jdouble l, jdouble r, jint samples) {
  GeogebraCommonKernelAlgosAlgoExtremumMulti_initialize();
  IOSDoubleArray *y = [IOSDoubleArray arrayWithLength:samples + 1];
  IOSBooleanArray *grad = [IOSBooleanArray arrayWithLength:samples];
  JavaUtilArrayList *xlist = [new_JavaUtilArrayList_init() autorelease];
  jdouble deltax = (r - l) / samples;
  GeogebraCommonKernelOptimizationExtremumFinder *extrfinder = [new_GeogebraCommonKernelOptimizationExtremumFinder_init() autorelease];
  for (jint i = 0; i <= samples; i++) {
    *IOSDoubleArray_GetRef(y, i) = [((id<GeogebraCommonKernelRootsRealRootFunction>) nil_chk(rrfunc)) evaluateWithDouble:l + i * deltax];
    if (i > 0) {
      if (IOSDoubleArray_Get(y, i) >= IOSDoubleArray_Get(y, i - 1)) {
        *IOSBooleanArray_GetRef(grad, i - 1) = YES;
      }
      else {
        *IOSBooleanArray_GetRef(grad, i - 1) = NO;
      }
    }
    if (i > 1) {
      jdouble xval = 0.0;
      jdouble curleft = l + (i - 2) * deltax;
      jdouble curright = curleft + 2 * deltax;
      if ((IOSBooleanArray_Get(grad, i - 2)) && (!IOSBooleanArray_Get(grad, i - 1))) {
        xval = [extrfinder findMaximumWithDouble:curleft withDouble:curright withGeogebraCommonKernelRootsRealRootFunction:rrfunc withDouble:3.0E-8];
        if (GeogebraCommonKernelAlgosAlgoExtremumMulti_gradientWithGeogebraCommonKernelRootsRealRootFunction_withDouble_withDouble_withDouble_(rrfunc, xval, curleft, curright) < 1.0E-4) {
          [xlist addWithId:[new_JavaLangDouble_initWithDouble_(xval) autorelease]];
        }
      }
      else if ((!IOSBooleanArray_Get(grad, i - 2)) && (IOSBooleanArray_Get(grad, i - 1))) {
        xval = [extrfinder findMinimumWithDouble:curleft withDouble:curright withGeogebraCommonKernelRootsRealRootFunction:rrfunc withDouble:3.0E-8];
        if (GeogebraCommonKernelAlgosAlgoExtremumMulti_gradientWithGeogebraCommonKernelRootsRealRootFunction_withDouble_withDouble_withDouble_(rrfunc, xval, curleft, curright) < 1.0E-4) {
          [xlist addWithId:[new_JavaLangDouble_initWithDouble_(xval) autorelease]];
        }
      }
      else {
      }
    }
  }
  IOSDoubleArray *result = [IOSDoubleArray arrayWithLength:[xlist size]];
  for (jint i = 0; i < [xlist size]; i++) {
    *IOSDoubleArray_GetRef(result, i) = [((JavaLangDouble *) nil_chk([xlist getWithInt:i])) doubleValue];
  }
  return result;
}

jint GeogebraCommonKernelAlgosAlgoExtremumMulti_findNumberOfSamplesWithDouble_withDouble_(GeogebraCommonKernelAlgosAlgoExtremumMulti *self, jdouble l, jdouble r) {
  jdouble visiblemax = [((GeogebraCommonKernelKernel *) nil_chk(self->kernel_)) getViewsXMaxWithGeogebraCommonKernelGeosGeoElement:IOSObjectArray_Get(nil_chk(self->points_), 0)];
  jdouble visiblemin = [self->kernel_ getViewsXMinWithGeogebraCommonKernelGeosGeoElement:IOSObjectArray_Get(self->points_, 0)];
  jdouble visiblepixs = [((GeogebraCommonMainApp *) nil_chk([self->kernel_ getApplication])) countPixelsWithDouble:visiblemin withDouble:visiblemax];
  jdouble pixsininterval = visiblepixs * (r - l) / (visiblemax - visiblemin);
  jint n = JavaLangMath_maxWithInt_withInt_(JavaLangMath_minWithInt_withInt_((jint) JavaLangMath_roundWithDouble_(pixsininterval / GeogebraCommonKernelAlgosAlgoExtremumMulti_PIXELS_BETWEEN_SAMPLES), GeogebraCommonKernelAlgosAlgoExtremumMulti_MAX_SAMPLES), GeogebraCommonKernelAlgosAlgoExtremumMulti_MIN_SAMPLES);
  return n;
}

jdouble GeogebraCommonKernelAlgosAlgoExtremumMulti_gradientWithGeogebraCommonKernelRootsRealRootFunction_withDouble_withDouble_withDouble_(id<GeogebraCommonKernelRootsRealRootFunction> rrf, jdouble x, jdouble l, jdouble r) {
  GeogebraCommonKernelAlgosAlgoExtremumMulti_initialize();
  jdouble dx = (r - l) / 1E8;
  return JavaLangMath_absWithDouble_(([((id<GeogebraCommonKernelRootsRealRootFunction>) nil_chk(rrf)) evaluateWithDouble:x + dx] - [rrf evaluateWithDouble:x]) / dx);
}

void GeogebraCommonKernelAlgosAlgoExtremumMulti_initWithGeogebraCommonKernelConstruction_(GeogebraCommonKernelAlgosAlgoExtremumMulti *self, GeogebraCommonKernelConstruction *cons) {
  GeogebraCommonKernelAlgosAlgoGeoPointsFunction_initWithGeogebraCommonKernelConstruction_(self, cons);
}

GeogebraCommonKernelAlgosAlgoExtremumMulti *new_GeogebraCommonKernelAlgosAlgoExtremumMulti_initWithGeogebraCommonKernelConstruction_(GeogebraCommonKernelConstruction *cons) {
  GeogebraCommonKernelAlgosAlgoExtremumMulti *self = [GeogebraCommonKernelAlgosAlgoExtremumMulti alloc];
  GeogebraCommonKernelAlgosAlgoExtremumMulti_initWithGeogebraCommonKernelConstruction_(self, cons);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(GeogebraCommonKernelAlgosAlgoExtremumMulti)

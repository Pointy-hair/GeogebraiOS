//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/jacky/GSoC/geogebra_iOS/geogebra/geogebra/common/src/geogebra/common/kernel/statistics/AlgoRandomPoisson.java
//


#include "IOSClass.h"
#include "IOSObjectArray.h"
#include "IOSPrimitiveArray.h"
#include "J2ObjC_source.h"
#include "geogebra/common/kernel/Construction.h"
#include "geogebra/common/kernel/Kernel.h"
#include "geogebra/common/kernel/algos/AlgoElement.h"
#include "geogebra/common/kernel/arithmetic/NumberValue.h"
#include "geogebra/common/kernel/commands/Commands.h"
#include "geogebra/common/kernel/geos/GeoElement.h"
#include "geogebra/common/kernel/geos/GeoNumeric.h"
#include "geogebra/common/kernel/statistics/AlgoRandomPoisson.h"
#include "geogebra/common/main/App.h"
#include "geogebra/common/util/MyMath2.h"
#include "java/lang/Math.h"

@interface GeogebraCommonKernelStatisticsAlgoRandomPoisson ()

- (jint)randomPoissonWithDouble:(jdouble)lambda;

- (jint)randomPoissonTRSWithDouble:(jdouble)mu;

+ (jdouble)logOfKFactorialWithInt:(jint)k;

@end

static jdouble GeogebraCommonKernelStatisticsAlgoRandomPoisson_halflog2pi_;
J2OBJC_STATIC_FIELD_GETTER(GeogebraCommonKernelStatisticsAlgoRandomPoisson, halflog2pi_, jdouble)
J2OBJC_STATIC_FIELD_REF_GETTER(GeogebraCommonKernelStatisticsAlgoRandomPoisson, halflog2pi_, jdouble)

static IOSDoubleArray *GeogebraCommonKernelStatisticsAlgoRandomPoisson_logtable_;
J2OBJC_STATIC_FIELD_GETTER(GeogebraCommonKernelStatisticsAlgoRandomPoisson, logtable_, IOSDoubleArray *)
J2OBJC_STATIC_FIELD_SETTER(GeogebraCommonKernelStatisticsAlgoRandomPoisson, logtable_, IOSDoubleArray *)

__attribute__((unused)) static void GeogebraCommonKernelStatisticsAlgoRandomPoisson_compute(GeogebraCommonKernelStatisticsAlgoRandomPoisson *self);

__attribute__((unused)) static jint GeogebraCommonKernelStatisticsAlgoRandomPoisson_randomPoissonWithDouble_(GeogebraCommonKernelStatisticsAlgoRandomPoisson *self, jdouble lambda);

__attribute__((unused)) static jint GeogebraCommonKernelStatisticsAlgoRandomPoisson_randomPoissonTRSWithDouble_(GeogebraCommonKernelStatisticsAlgoRandomPoisson *self, jdouble mu);

__attribute__((unused)) static jdouble GeogebraCommonKernelStatisticsAlgoRandomPoisson_logOfKFactorialWithInt_(jint k);

J2OBJC_INITIALIZED_DEFN(GeogebraCommonKernelStatisticsAlgoRandomPoisson)

@implementation GeogebraCommonKernelStatisticsAlgoRandomPoisson

- (instancetype)initWithGeogebraCommonKernelConstruction:(GeogebraCommonKernelConstruction *)cons
                                            withNSString:(NSString *)label
           withGeogebraCommonKernelArithmeticNumberValue:(id<GeogebraCommonKernelArithmeticNumberValue>)a {
  GeogebraCommonKernelStatisticsAlgoRandomPoisson_initWithGeogebraCommonKernelConstruction_withNSString_withGeogebraCommonKernelArithmeticNumberValue_(self, cons, label, a);
  return self;
}

- (void)setInputOutput {
  GeogebraCommonKernelAlgosAlgoElement_setAndConsume_input_(self, [IOSObjectArray newArrayWithLength:1 type:GeogebraCommonKernelGeosGeoElement_class_()]);
  IOSObjectArray_Set(input_, 0, [((id<GeogebraCommonKernelArithmeticNumberValue>) nil_chk(a_)) toGeoElement]);
  [self setOnlyOutputWithGeogebraCommonKernelGeosToGeoElement:num_];
  [self setDependencies];
}

- (GeogebraCommonKernelGeosGeoNumeric *)getResult {
  return num_;
}

- (GeogebraCommonKernelCommandsCommandsEnum *)getClassName {
  return GeogebraCommonKernelCommandsCommandsEnum_get_RandomPoisson();
}

- (void)compute {
  GeogebraCommonKernelStatisticsAlgoRandomPoisson_compute(self);
}

- (jint)randomPoissonWithDouble:(jdouble)lambda {
  return GeogebraCommonKernelStatisticsAlgoRandomPoisson_randomPoissonWithDouble_(self, lambda);
}

- (jint)randomPoissonTRSWithDouble:(jdouble)mu {
  return GeogebraCommonKernelStatisticsAlgoRandomPoisson_randomPoissonTRSWithDouble_(self, mu);
}

+ (jdouble)logOfKFactorialWithInt:(jint)k {
  return GeogebraCommonKernelStatisticsAlgoRandomPoisson_logOfKFactorialWithInt_(k);
}

- (void)setRandomValueWithDouble:(jdouble)d {
  d = JavaLangMath_roundWithDouble_(GeogebraCommonKernelKernel_checkIntegerWithDouble_(d));
  if (d >= 0) {
    [((GeogebraCommonKernelGeosGeoNumeric *) nil_chk(num_)) setValueWithDouble:d];
    [num_ updateRepaint];
  }
}

- (void)dealloc {
  RELEASE_(a_);
  RELEASE_(num_);
  [super dealloc];
}

+ (void)initialize {
  if (self == [GeogebraCommonKernelStatisticsAlgoRandomPoisson class]) {
    GeogebraCommonKernelStatisticsAlgoRandomPoisson_halflog2pi_ = 0.5 * JavaLangMath_logWithDouble_(2 * JavaLangMath_PI);
    JreStrongAssignAndConsume(&GeogebraCommonKernelStatisticsAlgoRandomPoisson_logtable_, nil, [IOSDoubleArray newArrayWithLength:10]);
    J2OBJC_SET_INITIALIZED(GeogebraCommonKernelStatisticsAlgoRandomPoisson)
  }
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithGeogebraCommonKernelConstruction:withNSString:withGeogebraCommonKernelArithmeticNumberValue:", "AlgoRandomPoisson", NULL, 0x1, NULL, NULL },
    { "setInputOutput", NULL, "V", 0x4, NULL, NULL },
    { "getResult", NULL, "Lgeogebra.common.kernel.geos.GeoNumeric;", 0x1, NULL, NULL },
    { "getClassName", NULL, "Lgeogebra.common.kernel.commands.Commands;", 0x1, NULL, NULL },
    { "compute", NULL, "V", 0x11, NULL, NULL },
    { "randomPoissonWithDouble:", "randomPoisson", "I", 0x2, NULL, NULL },
    { "randomPoissonTRSWithDouble:", "randomPoissonTRS", "I", 0x2, NULL, NULL },
    { "logOfKFactorialWithInt:", "logOfKFactorial", "D", 0xa, NULL, NULL },
    { "setRandomValueWithDouble:", "setRandomValue", "V", 0x1, NULL, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "a_", NULL, 0x4, "Lgeogebra.common.kernel.arithmetic.NumberValue;", NULL, NULL,  },
    { "num_", NULL, 0x4, "Lgeogebra.common.kernel.geos.GeoNumeric;", NULL, NULL,  },
    { "halflog2pi_", NULL, 0xa, "D", &GeogebraCommonKernelStatisticsAlgoRandomPoisson_halflog2pi_, NULL,  },
    { "logtable_", NULL, 0xa, "[D", &GeogebraCommonKernelStatisticsAlgoRandomPoisson_logtable_, NULL,  },
  };
  static const J2ObjcClassInfo _GeogebraCommonKernelStatisticsAlgoRandomPoisson = { 2, "AlgoRandomPoisson", "geogebra.common.kernel.statistics", NULL, 0x1, 9, methods, 4, fields, 0, NULL, 0, NULL, NULL, NULL };
  return &_GeogebraCommonKernelStatisticsAlgoRandomPoisson;
}

@end

void GeogebraCommonKernelStatisticsAlgoRandomPoisson_initWithGeogebraCommonKernelConstruction_withNSString_withGeogebraCommonKernelArithmeticNumberValue_(GeogebraCommonKernelStatisticsAlgoRandomPoisson *self, GeogebraCommonKernelConstruction *cons, NSString *label, id<GeogebraCommonKernelArithmeticNumberValue> a) {
  GeogebraCommonKernelAlgosAlgoElement_initWithGeogebraCommonKernelConstruction_(self, cons);
  GeogebraCommonKernelStatisticsAlgoRandomPoisson_set_a_(self, a);
  GeogebraCommonKernelStatisticsAlgoRandomPoisson_setAndConsume_num_(self, new_GeogebraCommonKernelGeosGeoNumeric_initWithGeogebraCommonKernelConstruction_(cons));
  [((GeogebraCommonKernelConstruction *) nil_chk(cons)) addRandomGeoWithGeogebraCommonKernelGeosGeoElement:self->num_];
  [self setInputOutput];
  GeogebraCommonKernelStatisticsAlgoRandomPoisson_compute(self);
  [self->num_ setLabelWithNSString:label];
}

GeogebraCommonKernelStatisticsAlgoRandomPoisson *new_GeogebraCommonKernelStatisticsAlgoRandomPoisson_initWithGeogebraCommonKernelConstruction_withNSString_withGeogebraCommonKernelArithmeticNumberValue_(GeogebraCommonKernelConstruction *cons, NSString *label, id<GeogebraCommonKernelArithmeticNumberValue> a) {
  GeogebraCommonKernelStatisticsAlgoRandomPoisson *self = [GeogebraCommonKernelStatisticsAlgoRandomPoisson alloc];
  GeogebraCommonKernelStatisticsAlgoRandomPoisson_initWithGeogebraCommonKernelConstruction_withNSString_withGeogebraCommonKernelArithmeticNumberValue_(self, cons, label, a);
  return self;
}

void GeogebraCommonKernelStatisticsAlgoRandomPoisson_compute(GeogebraCommonKernelStatisticsAlgoRandomPoisson *self) {
  if ([((GeogebraCommonKernelGeosGeoElement *) nil_chk(IOSObjectArray_Get(nil_chk(self->input_), 0))) isDefined]) {
    jdouble lambda = [((id<GeogebraCommonKernelArithmeticNumberValue>) nil_chk(self->a_)) getDouble];
    if (lambda > 0) [((GeogebraCommonKernelGeosGeoNumeric *) nil_chk(self->num_)) setValueWithDouble:GeogebraCommonKernelStatisticsAlgoRandomPoisson_randomPoissonTRSWithDouble_(self, lambda)];
    else [((GeogebraCommonKernelGeosGeoNumeric *) nil_chk(self->num_)) setUndefined];
  }
  else [((GeogebraCommonKernelGeosGeoNumeric *) nil_chk(self->num_)) setUndefined];
}

jint GeogebraCommonKernelStatisticsAlgoRandomPoisson_randomPoissonWithDouble_(GeogebraCommonKernelStatisticsAlgoRandomPoisson *self, jdouble lambda) {
  jdouble L = JavaLangMath_expWithDouble_(-lambda);
  jdouble p = 1;
  jint k = 0;
  do {
    k++;
    p *= [((GeogebraCommonMainApp *) nil_chk([((GeogebraCommonKernelKernel *) nil_chk(self->kernel_)) getApplication])) getRandomNumber];
  }
  while (p >= L);
  return k - 1;
}

jint GeogebraCommonKernelStatisticsAlgoRandomPoisson_randomPoissonTRSWithDouble_(GeogebraCommonKernelStatisticsAlgoRandomPoisson *self, jdouble mu) {
  if (mu < 10) return GeogebraCommonKernelStatisticsAlgoRandomPoisson_randomPoissonWithDouble_(self, mu);
  jdouble b = 0.931 + +2.53 * JavaLangMath_sqrtWithDouble_(mu);
  jdouble a = -0.059 + 0.02438 * b;
  jdouble v_r = 0.9277 - 3.6224 / (b - 2);
  jdouble us = 0;
  jdouble v = 1;
  while (YES) {
    jint k = -1;
    while (k < 0 || (us < 0.013 && v > us)) {
      jdouble u = [((GeogebraCommonMainApp *) nil_chk([((GeogebraCommonKernelKernel *) nil_chk(self->kernel_)) getApplication])) getRandomNumber] - 0.5;
      v = [((GeogebraCommonMainApp *) nil_chk([self->kernel_ getApplication])) getRandomNumber];
      us = 0.5 - JavaLangMath_absWithDouble_(u);
      k = J2ObjCFpToInt(JavaLangMath_floorWithDouble_((2 * a / us + b) * u + mu + 0.43));
      if (us >= 0.07 && v < v_r) return k;
    }
    jdouble alpha = 1.1239 + 1.1328 / (b - 3.4);
    jdouble lnmu = JavaLangMath_logWithDouble_(mu);
    v = v * alpha / (a / (us * us) + b);
    if (JavaLangMath_logWithDouble_(v * alpha / (a / us / us + b)) <= -mu + k * lnmu - GeogebraCommonKernelStatisticsAlgoRandomPoisson_logOfKFactorialWithInt_(k)) return k;
  }
}

jdouble GeogebraCommonKernelStatisticsAlgoRandomPoisson_logOfKFactorialWithInt_(jint k) {
  GeogebraCommonKernelStatisticsAlgoRandomPoisson_initialize();
  if (k < 10) {
    if (IOSDoubleArray_Get(nil_chk(GeogebraCommonKernelStatisticsAlgoRandomPoisson_logtable_), k) == 0) *IOSDoubleArray_GetRef(GeogebraCommonKernelStatisticsAlgoRandomPoisson_logtable_, k) = JavaLangMath_logWithDouble_(GeogebraCommonUtilMyMath2_factorialWithDouble_(k));
    return IOSDoubleArray_Get(GeogebraCommonKernelStatisticsAlgoRandomPoisson_logtable_, k);
  }
  return GeogebraCommonKernelStatisticsAlgoRandomPoisson_halflog2pi_ + (k + 0.5) * JavaLangMath_logWithDouble_(k + 1) - (k + 1) + (1 / 12.0 - (1 / 360.0 - 1 / 1260.0 / (k + 1) / (k + 1)) / (k + 1) / (k + 1)) / (k + 1);
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(GeogebraCommonKernelStatisticsAlgoRandomPoisson)

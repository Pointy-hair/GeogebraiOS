//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Users/jacky/GSoC/geogebra_iOS/geogebra/geogebra/common/src/geogebra/common/plugin/script/GgbScript.java
//


#include "IOSClass.h"
#include "IOSObjectArray.h"
#include "J2ObjC_source.h"
#include "geogebra/common/kernel/Kernel.h"
#include "geogebra/common/kernel/StringTemplate.h"
#include "geogebra/common/kernel/commands/AlgebraProcessor.h"
#include "geogebra/common/kernel/geos/GeoElement.h"
#include "geogebra/common/main/App.h"
#include "geogebra/common/main/Localization.h"
#include "geogebra/common/plugin/Event.h"
#include "geogebra/common/plugin/ScriptError.h"
#include "geogebra/common/plugin/ScriptType.h"
#include "geogebra/common/plugin/script/GgbScript.h"
#include "geogebra/common/plugin/script/Script.h"
#include "geogebra/common/util/StringUtil.h"
#include "java/lang/Character.h"
#include "java/lang/StringBuilder.h"
#include "java/lang/Throwable.h"
#include "java/util/ArrayList.h"

@interface GeogebraCommonPluginScriptGgbScript () {
 @public
  GeogebraCommonKernelCommandsAlgebraProcessor *proc_;
}

+ (jboolean)isFunctionWithNSStringArray:(IOSObjectArray *)starr
                                withInt:(jint)i
              withGeogebraCommonMainApp:(GeogebraCommonMainApp *)app;

+ (IOSObjectArray *)splitScriptByCommandsWithNSString:(NSString *)st;

+ (jboolean)bracketAtWithNSString:(NSString *)st
                          withInt:(jint)i;

@end

J2OBJC_FIELD_SETTER(GeogebraCommonPluginScriptGgbScript, proc_, GeogebraCommonKernelCommandsAlgebraProcessor *)

__attribute__((unused)) static jboolean GeogebraCommonPluginScriptGgbScript_isFunctionWithNSStringArray_withInt_withGeogebraCommonMainApp_(IOSObjectArray *starr, jint i, GeogebraCommonMainApp *app);

__attribute__((unused)) static IOSObjectArray *GeogebraCommonPluginScriptGgbScript_splitScriptByCommandsWithNSString_(NSString *st);

__attribute__((unused)) static jboolean GeogebraCommonPluginScriptGgbScript_bracketAtWithNSString_withInt_(NSString *st, jint i);

@implementation GeogebraCommonPluginScriptGgbScript

- (instancetype)initWithGeogebraCommonMainApp:(GeogebraCommonMainApp *)app
                                 withNSString:(NSString *)scriptText {
  GeogebraCommonPluginScriptGgbScript_initWithGeogebraCommonMainApp_withNSString_(self, app, scriptText);
  return self;
}

- (NSString *)getText {
  return GeogebraCommonPluginScriptGgbScript_script2LocalizedScriptWithGeogebraCommonMainApp_withNSString_(app_, text_);
}

- (void)runWithGeogebraCommonPluginEvent:(GeogebraCommonPluginEvent *)evt {
  NSString *scriptText;
  if (text_ == nil) {
    return;
  }
  if (((GeogebraCommonPluginEvent *) nil_chk(evt))->argument_ == nil) {
    scriptText = text_;
  }
  else {
    scriptText = [((NSString *) nil_chk(text_)) replaceAll:@"%0" withReplacement:evt->argument_];
  }
  IOSObjectArray *lines = [((NSString *) nil_chk(scriptText)) split:@"\n"];
  for (jint i = 0; i < ((IOSObjectArray *) nil_chk(lines))->size_; i++) {
    NSString *line = [((NSString *) nil_chk(IOSObjectArray_Get(lines, i))) trim];
    if ([((NSString *) nil_chk(line)) isEqual:@""] || [line charAtWithInt:0] == '#') {
      continue;
    }
    @try {
      [((GeogebraCommonKernelCommandsAlgebraProcessor *) nil_chk(proc_)) processAlgebraCommandNoExceptionHandlingWithNSString:line withBoolean:NO withBoolean:NO withBoolean:YES withBoolean:NO];
    }
    @catch (JavaLangThrowable *e) {
      @throw [new_GeogebraCommonPluginScriptError_initWithNSString_(JreStrcat("$C$", [((GeogebraCommonMainLocalization *) nil_chk([((GeogebraCommonMainApp *) nil_chk(app_)) getLocalization])) getPlainWithNSString:@"ErrorInScriptAtLineAFromObjectB" withNSString:JreStrcat("I", (i + 1)) withNSString:[((GeogebraCommonKernelGeosGeoElement *) nil_chk(evt->target_)) getLabelWithGeogebraCommonKernelStringTemplate:GeogebraCommonKernelStringTemplate_get_defaultTemplate_()]], 0x000a, [((JavaLangThrowable *) nil_chk(e)) getLocalizedMessage])) autorelease];
    }
  }
}

+ (NSString *)script2LocalizedScriptWithGeogebraCommonMainApp:(GeogebraCommonMainApp *)app
                                                 withNSString:(NSString *)st {
  return GeogebraCommonPluginScriptGgbScript_script2LocalizedScriptWithGeogebraCommonMainApp_withNSString_(app, st);
}

+ (jboolean)isFunctionWithNSStringArray:(IOSObjectArray *)starr
                                withInt:(jint)i
              withGeogebraCommonMainApp:(GeogebraCommonMainApp *)app {
  return GeogebraCommonPluginScriptGgbScript_isFunctionWithNSStringArray_withInt_withGeogebraCommonMainApp_(starr, i, app);
}

+ (NSString *)localizedScript2ScriptWithGeogebraCommonMainApp:(GeogebraCommonMainApp *)app
                                                 withNSString:(NSString *)st {
  return GeogebraCommonPluginScriptGgbScript_localizedScript2ScriptWithGeogebraCommonMainApp_withNSString_(app, st);
}

+ (IOSObjectArray *)splitScriptByCommandsWithNSString:(NSString *)st {
  return GeogebraCommonPluginScriptGgbScript_splitScriptByCommandsWithNSString_(st);
}

+ (jboolean)bracketAtWithNSString:(NSString *)st
                          withInt:(jint)i {
  return GeogebraCommonPluginScriptGgbScript_bracketAtWithNSString_withInt_(st, i);
}

- (GeogebraCommonPluginScriptTypeEnum *)getType {
  return GeogebraCommonPluginScriptTypeEnum_get_GGBSCRIPT();
}

- (GeogebraCommonPluginScriptScript *)copy__ {
  return [new_GeogebraCommonPluginScriptGgbScript_initWithGeogebraCommonMainApp_withNSString_(app_, text_) autorelease];
}

- (jboolean)renameGeoWithNSString:(NSString *)oldLabel
                     withNSString:(NSString *)newLabel {
  if (oldLabel == nil || [@"" isEqual:oldLabel] || newLabel == nil || [@"" isEqual:newLabel]) {
    return NO;
  }
  JavaUtilArrayList *work = GeogebraCommonUtilStringUtil_wholeWordTokenizeWithNSString_(text_);
  jboolean ret = NO;
  jint numChars = 0, lengthChars;
  NSString *forLength1, *forLength2;
  for (jint i = 1; i < [((JavaUtilArrayList *) nil_chk(work)) size]; i += 2) {
    if ([work getWithInt:i - 1] != nil) {
      numChars += ((jint) [((NSString *) nil_chk([work getWithInt:i - 1])) length]);
    }
    if ([((NSString *) nil_chk(oldLabel)) isEqual:[work getWithInt:i]]) {
      if (i + 1 < [work size] && [work getWithInt:i + 1] != nil) {
        if ((((jint) [((NSString *) nil_chk([work getWithInt:i + 1])) length]) > 0) && [@"[" isEqual:JavaLangCharacter_valueOfWithChar_([((NSString *) nil_chk([work getWithInt:i + 1])) charAtWithInt:0])]) {
          numChars += ((jint) [oldLabel length]);
          continue;
        }
      }
      forLength1 = [((NSString *) nil_chk([((NSString *) nil_chk(text_)) substring:0 endIndex:numChars])) replaceAll:@"\\\"" withReplacement:@""];
      forLength2 = [((NSString *) nil_chk(forLength1)) replaceAll:@"\"" withReplacement:@""];
      lengthChars = ((jint) [forLength1 length]) - ((jint) [((NSString *) nil_chk(forLength2)) length]);
      if (lengthChars % 2 == 1) {
        numChars += ((jint) [oldLabel length]);
        continue;
      }
      if ([work getWithInt:i] != nil) {
        numChars += ((jint) [((NSString *) nil_chk([work getWithInt:i])) length]);
      }
      [work setWithInt:i withId:newLabel];
      ret = YES;
    }
    else if ([work getWithInt:i] != nil) {
      numChars += ((jint) [((NSString *) nil_chk([work getWithInt:i])) length]);
    }
  }
  GeogebraCommonPluginScriptScript_set_text_(self, GeogebraCommonUtilStringUtil_joinTokensWithJavaLangIterable_withNSString_(work, nil));
  return ret;
}

- (void)dealloc {
  RELEASE_(proc_);
  [super dealloc];
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "initWithGeogebraCommonMainApp:withNSString:", "GgbScript", NULL, 0x1, NULL, NULL },
    { "getText", NULL, "Ljava.lang.String;", 0x1, NULL, NULL },
    { "runWithGeogebraCommonPluginEvent:", "run", "V", 0x1, "Lgeogebra.common.plugin.ScriptError;", NULL },
    { "script2LocalizedScriptWithGeogebraCommonMainApp:withNSString:", "script2LocalizedScript", "Ljava.lang.String;", 0x9, NULL, NULL },
    { "isFunctionWithNSStringArray:withInt:withGeogebraCommonMainApp:", "isFunction", "Z", 0xa, NULL, NULL },
    { "localizedScript2ScriptWithGeogebraCommonMainApp:withNSString:", "localizedScript2Script", "Ljava.lang.String;", 0x9, NULL, NULL },
    { "splitScriptByCommandsWithNSString:", "splitScriptByCommands", "[Ljava.lang.String;", 0xa, NULL, NULL },
    { "bracketAtWithNSString:withInt:", "bracketAt", "Z", 0xa, NULL, NULL },
    { "getType", NULL, "Lgeogebra.common.plugin.ScriptType;", 0x1, NULL, NULL },
    { "copy__", "copy", "Lgeogebra.common.plugin.script.Script;", 0x1, NULL, NULL },
    { "renameGeoWithNSString:withNSString:", "renameGeo", "Z", 0x1, NULL, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "proc_", NULL, 0x2, "Lgeogebra.common.kernel.commands.AlgebraProcessor;", NULL, NULL,  },
  };
  static const J2ObjcClassInfo _GeogebraCommonPluginScriptGgbScript = { 2, "GgbScript", "geogebra.common.plugin.script", NULL, 0x1, 11, methods, 1, fields, 0, NULL, 0, NULL, NULL, NULL };
  return &_GeogebraCommonPluginScriptGgbScript;
}

@end

void GeogebraCommonPluginScriptGgbScript_initWithGeogebraCommonMainApp_withNSString_(GeogebraCommonPluginScriptGgbScript *self, GeogebraCommonMainApp *app, NSString *scriptText) {
  GeogebraCommonPluginScriptScript_initWithGeogebraCommonMainApp_withNSString_(self, app, scriptText);
  GeogebraCommonPluginScriptGgbScript_set_proc_(self, [((GeogebraCommonKernelKernel *) nil_chk([((GeogebraCommonMainApp *) nil_chk(app)) getKernel])) getAlgebraProcessor]);
}

GeogebraCommonPluginScriptGgbScript *new_GeogebraCommonPluginScriptGgbScript_initWithGeogebraCommonMainApp_withNSString_(GeogebraCommonMainApp *app, NSString *scriptText) {
  GeogebraCommonPluginScriptGgbScript *self = [GeogebraCommonPluginScriptGgbScript alloc];
  GeogebraCommonPluginScriptGgbScript_initWithGeogebraCommonMainApp_withNSString_(self, app, scriptText);
  return self;
}

NSString *GeogebraCommonPluginScriptGgbScript_script2LocalizedScriptWithGeogebraCommonMainApp_withNSString_(GeogebraCommonMainApp *app, NSString *st) {
  GeogebraCommonPluginScriptGgbScript_initialize();
  IOSObjectArray *starr = GeogebraCommonPluginScriptGgbScript_splitScriptByCommandsWithNSString_(st);
  JavaLangStringBuilder *retone = [new_JavaLangStringBuilder_init() autorelease];
  for (jint i = 0; i < ((IOSObjectArray *) nil_chk(starr))->size_; i++) {
    if ((i % 2) == 0 || GeogebraCommonPluginScriptGgbScript_isFunctionWithNSStringArray_withInt_withGeogebraCommonMainApp_(starr, i, app)) {
      [retone appendWithNSString:IOSObjectArray_Get(starr, i)];
    }
    else {
      [retone appendWithNSString:[((GeogebraCommonMainLocalization *) nil_chk([((GeogebraCommonMainApp *) nil_chk(app)) getLocalization])) getCommandWithNSString:IOSObjectArray_Get(starr, i)]];
    }
  }
  return [retone description];
}

jboolean GeogebraCommonPluginScriptGgbScript_isFunctionWithNSStringArray_withInt_withGeogebraCommonMainApp_(IOSObjectArray *starr, jint i, GeogebraCommonMainApp *app) {
  GeogebraCommonPluginScriptGgbScript_initialize();
  if (i >= ((IOSObjectArray *) nil_chk(starr))->size_ - 1 || [((NSString *) nil_chk(IOSObjectArray_Get(starr, i + 1))) hasPrefix:@"["]) return NO;
  if ([((GeogebraCommonKernelKernel *) nil_chk([((GeogebraCommonMainApp *) nil_chk(app)) getKernel])) lookupLabelWithNSString:IOSObjectArray_Get(starr, i)] != nil) return YES;
  return NO;
}

NSString *GeogebraCommonPluginScriptGgbScript_localizedScript2ScriptWithGeogebraCommonMainApp_withNSString_(GeogebraCommonMainApp *app, NSString *st) {
  GeogebraCommonPluginScriptGgbScript_initialize();
  IOSObjectArray *starr = GeogebraCommonPluginScriptGgbScript_splitScriptByCommandsWithNSString_(st);
  JavaLangStringBuilder *retone = [new_JavaLangStringBuilder_init() autorelease];
  for (jint i = 0; i < ((IOSObjectArray *) nil_chk(starr))->size_; i++) {
    if ((i % 2) == 0) {
      [retone appendWithNSString:IOSObjectArray_Get(starr, i)];
    }
    else {
      if (!GeogebraCommonPluginScriptGgbScript_isFunctionWithNSStringArray_withInt_withGeogebraCommonMainApp_(starr, i, app) && [((GeogebraCommonMainApp *) nil_chk(app)) getInternalCommandWithNSString:IOSObjectArray_Get(starr, i)] != nil) {
        [retone appendWithNSString:[app getInternalCommandWithNSString:IOSObjectArray_Get(starr, i)]];
      }
      else {
        [retone appendWithNSString:IOSObjectArray_Get(starr, i)];
      }
    }
  }
  return [retone description];
}

IOSObjectArray *GeogebraCommonPluginScriptGgbScript_splitScriptByCommandsWithNSString_(NSString *st) {
  GeogebraCommonPluginScriptGgbScript_initialize();
  JavaLangStringBuilder *retone = [new_JavaLangStringBuilder_init() autorelease];
  JavaUtilArrayList *ret = [new_JavaUtilArrayList_init() autorelease];
  jint countapo = 0;
  for (jint j = 0; j < ((jint) [((NSString *) nil_chk(st)) length]); j++) {
    if ([st charAtWithInt:j] == '"') {
      countapo++;
    }
  }
  jboolean in_string = NO;
  if ((countapo % 2) == 1) {
    in_string = YES;
  }
  jboolean before_bracket = NO;
  jboolean just_before_bracket = NO;
  for (jint i = ((jint) [st length]) - 1; i >= 0; i--) {
    if (in_string) {
      if ([st charAtWithInt:i] == '"') {
        in_string = NO;
      }
    }
    else if (just_before_bracket) {
      if (GeogebraCommonUtilStringUtil_isLetterOrDigitOrUnderscoreWithChar_([st charAtWithInt:i])) {
        [ret addWithInt:0 withId:[retone description]];
        retone = [new_JavaLangStringBuilder_init() autorelease];
        just_before_bracket = NO;
        before_bracket = YES;
      }
      else if (!GeogebraCommonPluginScriptGgbScript_bracketAtWithNSString_withInt_(st, i) && ([st charAtWithInt:i] != ' ')) {
        just_before_bracket = NO;
        before_bracket = NO;
        if ([st charAtWithInt:i] == '"') {
          in_string = YES;
        }
      }
    }
    else if (before_bracket) {
      if (!GeogebraCommonUtilStringUtil_isLetterOrDigitOrUnderscoreWithChar_([st charAtWithInt:i])) {
        [ret addWithInt:0 withId:[retone description]];
        retone = [new_JavaLangStringBuilder_init() autorelease];
        before_bracket = NO;
        if ([st charAtWithInt:i] == '"') {
          in_string = YES;
        }
        else if (GeogebraCommonPluginScriptGgbScript_bracketAtWithNSString_withInt_(st, i)) {
          just_before_bracket = YES;
        }
      }
    }
    else {
      if ([st charAtWithInt:i] == '"') {
        in_string = YES;
      }
      else if (GeogebraCommonPluginScriptGgbScript_bracketAtWithNSString_withInt_(st, i)) {
        just_before_bracket = YES;
      }
    }
    [retone insertWithInt:0 withChar:[st charAtWithInt:i]];
  }
  [ret addWithInt:0 withId:[retone description]];
  if (before_bracket) {
    [ret addWithInt:0 withId:@""];
  }
  IOSObjectArray *ex = [IOSObjectArray arrayWithObjects:(id[]){ @"" } count:1 type:NSString_class_()];
  return [ret toArrayWithNSObjectArray:ex];
}

jboolean GeogebraCommonPluginScriptGgbScript_bracketAtWithNSString_withInt_(NSString *st, jint i) {
  GeogebraCommonPluginScriptGgbScript_initialize();
  return ([((NSString *) nil_chk(st)) charAtWithInt:i] == '[') || ([st charAtWithInt:i] == '(');
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(GeogebraCommonPluginScriptGgbScript)
